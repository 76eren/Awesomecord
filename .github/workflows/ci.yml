name: Awesomecord Release Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  TAG: v${{ github.run_number }}
  IMAGE_BACKEND: awesomecord-backend
  IMAGE_FRONTEND: awesomecord-frontend
  DEPLOYMENT_SERVER_DIRECTORY: ${{ secrets.DEPLOYMENT_SERVER_DIRECTORY }}
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
  SSH_KEY: ${{ secrets.SSH_KEY }}

  ENV_DOCKER_COMPOSE: ${{ secrets.ENV_DOCKER_COMPOSE }}
  DOTNET_ENV_PRODUCTION: ${{ secrets.DOTNET_ENV_PRODUCTION }}
  ENV_FRONTEND: ${{ secrets.ENV_FRONTEND }}

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner
        id: repo
        run: echo "owner_lc=${GITHUB_REPOSITORY_OWNER@L}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./Backend/Awesomecord
          file: ./Backend/Awesomecord/API/Dockerfile
          push: true
          provenance: false
          tags: |
            ghcr.io/${{ steps.repo.outputs.owner_lc }}/${{ env.IMAGE_BACKEND }}:${{ env.TAG }}
            ghcr.io/${{ steps.repo.outputs.owner_lc }}/${{ env.IMAGE_BACKEND }}:latest

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./Frontend/awesomecord-front
          file: ./Frontend/awesomecord-front/Dockerfile
          push: true
          provenance: false
          build-args: |
            VITE_PUBLIC_API_URL=${{ secrets.PUBLIC_API_URL }}
          tags: |
            ghcr.io/${{ steps.repo.outputs.owner_lc }}/${{ env.IMAGE_FRONTEND }}:${{ env.TAG }}
            ghcr.io/${{ steps.repo.outputs.owner_lc }}/${{ env.IMAGE_FRONTEND }}:latest

      - name: Upload deploy compose
        uses: actions/upload-artifact@v4
        with:
          name: deploy-compose
          path: docker-compose.deploy.yml

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Download deploy compose
        uses: actions/download-artifact@v4
        with:
          name: deploy-compose
          path: .

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${SSH_KEY}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${SERVER_IP}" >> ~/.ssh/known_hosts

      - name: Create directory structure on server
        run: |
          ssh -i ~/.ssh/id_ed25519 ${SSH_USERNAME}@${SERVER_IP} <<EOF
          set -eo pipefail
          DEPLOYMENT_SERVER_DIRECTORY="${DEPLOYMENT_SERVER_DIRECTORY}"
          mkdir -p "\$DEPLOYMENT_SERVER_DIRECTORY/Frontend/awesomecord-front"
          mkdir -p "\$DEPLOYMENT_SERVER_DIRECTORY/Backend/Awesomecord/API"
          EOF

      - name: Push docker-compose.deploy.yml to server
        run: |
          scp -i ~/.ssh/id_ed25519 docker-compose.deploy.yml \
            ${SSH_USERNAME}@${SERVER_IP}:"${DEPLOYMENT_SERVER_DIRECTORY}/docker-compose.deploy.yml"

      - name: Write env files on server
        env:
          TAG: ${{ env.TAG }}
          GH_OWNER: ${{ github.repository_owner }}
        run: |
          ssh -i ~/.ssh/id_ed25519 ${SSH_USERNAME}@${SERVER_IP} <<EOF
          set -eo pipefail
          DEPLOYMENT_SERVER_DIRECTORY="${DEPLOYMENT_SERVER_DIRECTORY}"

          cat > "\$DEPLOYMENT_SERVER_DIRECTORY/.env" << 'EOROOT'
          ${ENV_DOCKER_COMPOSE}
          EOROOT

          TAG_VALUE="${TAG}"
          GH_OWNER_LC="\$(printf '%s' "${GH_OWNER}" | tr '[:upper:]' '[:lower:]')"
          {
            printf 'TAG=%s\n' "\$TAG_VALUE"
            printf 'GH_OWNER=%s\n' "\$GH_OWNER_LC"
          } >> "\$DEPLOYMENT_SERVER_DIRECTORY/.env"

          cat > "\$DEPLOYMENT_SERVER_DIRECTORY/Frontend/awesomecord-front/.env" << 'EOFE'
          ${ENV_FRONTEND}
          EOFE

          cat > "\$DEPLOYMENT_SERVER_DIRECTORY/Backend/Awesomecord/API/.env.production" << 'EOBE'
          ${DOTNET_ENV_PRODUCTION}
          EOBE
          EOF

      - name: Pull and run containers on server
        run: |
          ssh -i ~/.ssh/id_ed25519 ${SSH_USERNAME}@${SERVER_IP} <<EOF
          set -eo pipefail
          cd "${DEPLOYMENT_SERVER_DIRECTORY}"
          docker compose -f docker-compose.deploy.yml pull
          docker compose -f docker-compose.deploy.yml up -d
          EOF
